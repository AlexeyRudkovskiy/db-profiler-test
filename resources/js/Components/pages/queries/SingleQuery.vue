<template>
<div>
    <!-- Single Query navigation -->
    <div class="px-6 bg-sky-500 text-white">
        <!-- Tabs -->
        <div class="pt-4 space-x-2 overflow-hidden">
            <span class="tab-item" v-bind:class="{'active': tab === 'query'}" @click="switchTab('query')">Query</span>
            <span class="tab-item" v-bind:class="{'active': tab === 'bindings'}" @click="switchTab('bindings')">Bindings</span>
            <span class="tab-item" v-bind:class="{'active': tab === 'explain'}" @click="switchTab('explain')">Explain</span>
            <span class="tab-item" v-bind:class="{'active': tab === 'batch'}" @click="switchTab('batch')">Batch</span>
        </div>
        <!-- End Tabs -->
    </div>

    <div class="p-6">

        <div v-if="tab === 'query'">
            <pre><!--
                --><code class="text-sm"><!--
                --><div v-for="(line, index) in parts"><!--
                        --><template v-for="item in line"><!--
                            --><span v-if="item.type === 'text'">{{ item.item }}</span><!--
                            --><query-param v-if="item.type === 'binding'" :param="getQueryParam(item.position)"></query-param><!--
                        --></template><!--
                --></div><!--
                --></code><!--
            --></pre>
        </div>

        <div v-if="tab === 'bindings'">
            <div class="overflow-x-auto relative">
                <table class="text-sm text-left text-gray-500 table-auto">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="py-3 px-6">
                            Position
                        </th>
                        <th scope="col" class="py-3 px-6">
                            Type
                        </th>
                        <th scope="col" class="py-3 px-6">
                            Value
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="bg-white border-b" v-for="(binding, position) in query.bindings">
                        <th scope="row" class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">
                            {{ position }}
                        </th>
                        <td class="py-4 px-6">
                            {{ binding.type }}
                        </td>
                        <td class="py-4 px-6">
                            {{ binding.value }}
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="tab === 'explain'">
            <explain-query :query="query"></explain-query>
        </div>

        <div v-if="tab === 'batch'">
            <batch :batch="query.batch" :query="query" @show-query="showQuery($event)"></batch>
        </div>

    </div>
</div>
</template>

<script>
import QueryParam from './../../Components/QueryParam.vue'
import EditBounding from './../../Components/EditBounding.vue'
import Batch from './Batch.vue'
import ExplainQuery from './ExplainQuery.vue'

export default {
    name: "SingleQuery",
    components: {
        QueryParam,
        EditBounding,
        Batch,
        ExplainQuery
    },
    props: [
        'query'
    ],
    data() {
        return {
            tab: 'query',
            parts: []
        };
    },
    methods: {
        formatQuery() {
            const {query} = this.query;
            const replacedQuery = query.replaceAll('?', ':?:');
            const parts = replacedQuery.split("\n");
            let lastBindingPosition = -1;
            this.parts = parts.map((line) => {
                return line.split(':').map(item => {
                    const type = item === '?' ? 'binding' : 'text';
                    const token = { type, item };

                    if (type === 'binding') {
                        lastBindingPosition++;
                        token.position = lastBindingPosition;
                    }

                    return token;
                });
            });

            // this.parts = query.split('?');
        },
        getQueryParam(index) {
            return this.query.bindings[index];
        },
        hasQueryParam(index) {
            return this.query.bindings.length > index;
        },
        showQuery(row) {
            this.$emit('show-query', row.id);
        },

        switchTab(newTab) {
            this.tab = newTab;
        }
    },
    watch: {
        query() {
            this.formatQuery();
            this.tab = 'query';
        }
    },
    mounted() {
        this.formatQuery();
    }
}
</script>

<style scoped>

</style>
